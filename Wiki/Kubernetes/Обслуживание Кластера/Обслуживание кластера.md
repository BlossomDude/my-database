
## Отключение узла

Что происходит когда один из узлов был отключен?
- Если один из узлов отключился и включился в течении 5 минут, то podы включатся и все будет нормально
- Если узел не доступен более 5 минут, то master узел считает этот узел мертвым как и котнейнеры на нем. 
	- Поды в Replica Set, восстановятся на других узлах если это возможно.

Мы можем освободить узел от всех нагрузок использую команду:
- `kubectl drain <node_name>`
После ввода данной команды все поды на данном узле завершаются и воссоздаются на других узлах. 
Так же этот узел помечается как `unschedulable`. Для того чтобы вернуть статус `schedulable` введите следующую команду:
- `kubectl uncordon <node_name>`

---
## Совместимость версий компонентов

>[!info]
>Kubernetes поддерживает только три последних минорных версий.

Каждый компонент kubernetes имеет свою версию, так как все они работают как отдельная единица. Kube-apiserver в данном случае является главным и от него должны отталкиваться.
- `kube-apiserver` - `v1.10` - Допустим эта версия на данный момент 
- `kube-scheduler` - Может иметь версию такую же, или `v1.9`
- `kube-controller` - Может иметь версию такую же, или `v1.9`
- `kube-proxy` - Может иметь версию такую же, или `v1.9` или `v1.8`
- `kubelet` - Может иметь версию такую же, или `v1.9` или `v1.8`
- `kubectl` - Может иметь версию такую же, или `v1.11` или `v1.9`

---

### Обновление компонентов кластера - рекомендации

>[!Tip]
>Рекомендуется обновлять за раз на одну мажорную версию выше.

- Во первых необходимо обновить мастер-узлы.
	Во время обновления компонентов на мастер узле, функции управления будут недоступны, мы не сможем создавать поды и отдавать команды. Но сами поды будут работать.
- После этого во избежания простоя, нужно обновлять рабочие узлы по одному. 
	Для того чтобы никакое приложение не пострадало, каждый под должен быть в Replica Set, чтобы данный под перешел на другой узел на время обновления компонентов узла. Обновляем так каждый узел.
	Так же существует стратегия добавления новых узлов с обновленными компонентами и выводом из эксплуатации старых узлов.

---
### Обновление компонентов мастера используя kubeadm 

Проверим информацию о кластере, а именно о версии компонентов и доступные версии:
```bash
kubeadm upgrade plan
```

Перед тем как обновлять кластер необходимо обновить `kubeadm`:
```bash
apt upgrade -y kubeadm=1.18.0-00
kubeadm upgrade node
```
Данная команда не обновляет kubelet, его необходимо обновить отдельно.

После этого выполнить обновление компонентов кластера командой:
```bash
kubeadm upgrade plan v1.31.0
kubeadm upgrade apply v1.18.0
```

---
## Обновление kubelet

Для начала пометьте узел как `unschedulable` и переместите поды на другие узлы:
```bash
## Данная команда выполняется на мастер узле
kubectl drain node_name
```

Для обновления kubelet выполните следующие команды на worker-node (кроме 1ой и посл.):
```bash
apt upgrade -y kubeadm=1.18.0-00
apt upgrade kubelet=1.18.0-00
kubeadm upgrade node config --kubelet-version v1.18.0
systemctl restart kubelet
```

После обновления kubelet, снимите метку с узла(Поды которые были на нем не вернуться). 
```bash
## Данная команда выполняется на мастер узле
kubectl uncordon node_name
```