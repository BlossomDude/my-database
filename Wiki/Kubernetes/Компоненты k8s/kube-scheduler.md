
- [[#Описание]]
- 
---
### Описание
---
kube-sheduler - Компонент k8s, планирующий, на каких узлах разворачивать поды. Он учитывает такие факторы, как ограничения, требования к ресурсам, местонахождение данных и пр. Работает на master-нодах;

```
# Файл с конфигурацие пода планировщика.
/etc/kubernetes/manifests.kube-scheduler.yaml
```

> [!important] Он только принимает решения куда будет установлен под. Но не размещает поды на узлах, это работа kubelet.

---
### Выборка нод
---
В каждом файле манифеста пода есть неявная директива `spec.nodeName` в которую можно указать узел в котором будет развернут под.
- Если узел не найден то под будет в состоянии `Pending`
- Узел нельзя поменять при уже работающем контейнере
- Если узел не указан явно то kube-scheduler назначит его автоматически используя механизмы afinity, taints, tolerations и учитывать оценку узлов.

Как scheduler ставит оценку узлам:
1) Сначала он фильтрует узлы. Например нашему под нужно 10 cpu. Значит ноды с cpu<10 не подходят.
2) Далее идет ранжировка узлов. Kube-scheduler дает оценку нодам от 1 до 10, используя функцию приоритета.
3) После получения оценки он выбирает лучший узел.
#### Варианты назначения узла:
- Оценка узла. Назначение узла исходя из его оценки планировщиком.
- `spec.tolerations`. Назначение исходя из [[Taints & Tolerations]].
- `spec.nodeName`. Строгое назначение используя.
- `spec.nodeSelector`. Строгое назначение по лейблам  
- `spec.affinity`.

#### Перепривязка работающего пода к другому узлу  
Чтобы перепривязать под к другому узлу во время его работы необходимо использовать binding:
```yaml
apiVersion: v1
kind: Binding
metadata:
  name: some-name
target:
  apiVersion: v1
  kind: Node
  name: node_name
```
Далее необходимо конвертировать этот файл в json формат и отправить Post запрос имитируя настоящий `kube-scheduler`:
``` bash
curl --header "Content-Type:application/json" \
     --request POST \
     --data $(kubectl apply -f values.yaml --dry-run=client -o json) \
     http://$SERVER/api/v1/namespaces/default/pods/$PODNAME/binding

```

---
